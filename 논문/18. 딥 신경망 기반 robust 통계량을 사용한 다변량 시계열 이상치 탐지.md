# 딥 신경망 기반 robust 통계량을 사용한 다변량 시계열 이상치 탐지 
**논문 저자**: 김선영, 김동일  

**분석 담당**: 고유미 

http://www.dbpia.co.kr/journal/articleDetail?nodeId=NODE10529695  
  
  

**논문 선정 이유**
- 신호데이터 처리에 있어서 노이즈 제거시 푸리에변환 이외 웨이브릿 필터링 방법 제시
- 비지도학습 이상탐지에 쓰인 모델을 확인하고자 -> (이 논문에서는 CAE 사용)
- 비지도학습 이상탐지에 적합한 평가지표 활용 (MSE가 아닌 논문에서는 로버스트 통계량을 이용해이상치 스코어를 계산)

## **요약**
- 다변량 시계열 데이터의 증가에 따라 신호데이터에서의 이상치 탐지 중요성 또한 증가
- 이상치를 탐지하는 데 로버스트 통계량(robust statistics)을 사용하는 것을 제안
- 이들의 로버스트한 통계량인 중앙값과 중앙값 절대 편차 (median) (MAD:median absolute deviation)을 사용
- 신호의 잡음을 제거하기 위한 **웨이블릿(wavelet) 필터링**에서의 **임계값 설정(thresholding)** 에 있어서 기존에 사용된 표준편차가 아닌 **중앙값 절대 편차**를 사용하고 각 윈도우에서의 **이상치 점수를 계산하는데 평균과 표준편차 각각을 대신하여 중앙값과 중앙값 절대 편차**를 사용
- 제안된 방법을 웨어러블 디바이스를 통해 얻어진 데이터로부터 노인 우울 예측 연구에 적용
  
    
    
## **서론**
- 다변량 시계열, 신호 데이터에 대한 처리 및 분석의 필요성이 증가
- 작은 시간 단위로 수집되어지는 **시계열 데이터들의 특성상 원시 데이터(raw data)에 노이즈가 많이 함유**되어 있기 때문에 신호 처리를 통해 어느 정도 **신호 잡음을 처리**한 후에 모델 학습을 진행
- 다변량 시계열 데이터를 대상으로 이루어지는 다양한 연구들 중 이상치 탐지 분야는 어려운 일로 알려져 있음
- 특히 recurrent neural networks(RNN)과 long-short term memory(LSTM)을 활용한 연구들이 주로 이루어지고 있음  
 
   ▶**이상치**: 다른 정상적인 관측치와 크게 벗어나는 다른 매커니즘에 의해 생성되었다는 의심을 불러일으키는 관측치  

   ▶**이상치 탐지**: 정상적인 데이터 분포에서 크게 벗어난 새롭거나 이전에 관찰되지 않은 패턴을 식별  

- 본 논문에서는 **정상으로 알려진 데이터로 학습 데이터를 구성**하고 정상 패턴에서 벗어난 데이터를 감지하는 **비지도 이상치 탐지 방법(unsupervised anomaly detection)** 을 사용  
  
	-> 그 중에서도 **오토인코더(auto encoder)방법**을 사용  
  
- 주기성과 항상성을 가지고 있는 시계열 데이터의 특성을 고려하면서 연산 비용이 RNN과 LSTM의 연산비용보다 적게 드는 **합성곱 신경망(convolutional neural network: CNN)구조**를 사용
- 합성곱 오토인코더(CAE)를 통해 얻어지는 복원 오류(reconstruction error)를 가지고 정해진 크기의 윈도우 단위로 이상치 점수(anomaly score)를 계산하는 방식으로 이상치를 탐지
- 계산된 다차원 이상치 점수를 하나의 차원으로 집적하는 과정(aggregating process)을 거침
- 1차원 벡터로 표현된 테스트 데이터의 이상치 점수 벡터를 가지고 검증 데이터 셋(validation dataset)으로부터 얻은 **임계값(threshold)을 기준**으로 이상치의 비율(anomaly rate)을 계산하여 최종적으로 **각 데이터 셋에 하나의 이상치 비율이 계산**되게 되며 이를 가지고 **최종적으로 데이터셋 전체의 이상여부**에 대해 판단  


 ![그림1](https://user-images.githubusercontent.com/62432967/128638318-52ccd8fb-6e24-4a10-a1fc-6b205dc98d7f.png)

  
  
## **신호 데이터의 웨이블릿 필터링과 (wavelet) CAE(convolutional autoencoder)**
### **웨이블릿 필터**
- **푸리에 변환(fourier transform)** 은 신호분석에 강력한 도구로 알려져 있으나 시간에 제한되지 않는 사인함수와 코사인함수의 합성으로 나타내기 때문에 **급격한 변화가 있는 신호에 대해서는 적절하게 사용되지 못한다는 단점**    
 
   -> 이러한 단점을 보완하는 것이 **웨이블릿 변환**  

- 웨이브릿 변환은 작은 단위의 웨이블릿을 가지고 파장과 진폭의 변화를 주어 유사도를 계산하고 가장 높은 유사도를 가지는 계수를 구함
- 웨이블릿 변환을 가지고 **데이터에서의 잡음을 제거**할 수 있는데 이를 **웨이블릿 수축 및 임계값 설정(wavelet shrinkage and thresholding)** 이라고 함
- 웨이블릿을 가지고 데이터를 분해할 때 평균 필터처럼 작용하는 필터를 사용하며 **임계값 설정은 임계값보다 작은 계수들은 0의 값으로 주는 개념**과 동일
- 이렇게 정돈된 계수들을 가지고 다시 역 웨이블릿 변환을 하여 데이터의 복원을 하면 웨이블릿 필터링이 됨
  
  
### **합성곱 오토인코더(CAE)**
- 합성곱 신경망(CNN)과 오토인코더(AutoEncoder)의 기본 원리를 결합하여 CAE를 생성
- 오토인코더는 입력된 데이터와 출력된 데이터가 가능한 유사하도록 모델을 학습
- 합성곱 신경망을 오토인코더로 사용하기 위해  
 
   -> 각 합성곱 레이어에 해당하는 deconvolution 레이어를 구성  

       - 인코더 부분에서는 풀링(pooling)으로 차원을 줄여나가고 
       - 디코더 부분에서는 언풀링(unpooling)으로 줄여진 차원을 늘려 다시 복원 시켜나가는 구조

  
  
## **CAE를 이용한 비지도 다변량 이상치 탐지 방법**  

### **진행 방법**
 ![그림1](https://user-images.githubusercontent.com/62432967/128638318-52ccd8fb-6e24-4a10-a1fc-6b205dc98d7f.png)  
 
 
- 이상치 탐지 방법은 위 그림에서 나타내는 것과 같이 크게 5단계로 구성
- 센서를 통해 동시적으로 들어오는 다변량 데이터들의 노이즈를 제거하는 필터링 
- 정제된 정상데이터로 합성곱 오토인코더를 학습시킨 후 복원 오차를 계산
- 사용자가 지정한 크기의 논 오버래핑 윈도우 방식으로 다차원의 복원 오차를 가지고 **이상치 점수를 계산**  
- 다차원의 이상치 점수 벡터를 윈도우 단위로 가중 평균하여 일차원의 이상치 점수 벡터로 계산
- 일차원 이상치 점수 벡터를 가지고 검증 데이터 셋을 기준으로 얻은 **임계값을 기준으로 삼아 전체에 대한 이상치 비율을 구하고** 그 비율을 통해 데이터가 정상 데이터인지 이상치 데이터인지 판단
  
  
### **로버스트 웨이블릿 필터**
- 노이즈가 섞인 시그널 데이터에 대해 웨이블릿 필터링을할 경우 threshold를 기준으로 노이즈를 정제
- 기존 웨이브릿 필터에서 임계값으로 사용되는 값  

![캡처](https://user-images.githubusercontent.com/62432967/128653449-9f6b6489-24e0-404d-b3a0-7d238dc8b4eb.PNG)  

- 기존의 필터링의 임계값에 사용되는 **표준편차를 대신하여 표준편차의 로버스트 통계값**이 중앙값 절대 편차를 사용 -> 보다 강건한 임계값을 주어 필터링을 진행 및 정제된 데이터를 CAE의 입력값으로 줌

  
  
### 윈도우 이상치 스코어링
1. CAE의 출력값과 입력값의 차이를 계산하여 다차원의 복원 오차를 구함
2. 이를 다시 입력으로 받아 non-over wrapping window 방법으로 고정된 크기의 겹치지 않는 윈도우를 씌움
3. 윈도우마다 계산된 복원오차의 제곱을 계산하고 각각의 윈도우 단위로 통계량을 계산  

  
### 대표 이상치 스코어링
- 각 차원의 윈도우 마다 계산되어진 다차원의 이상치 스코어를 단일 차원의 대표 이상치 스코어로 계산
- 이때 가중평균을 사용 -> 하나의 윈도우의 여러 채널의 이상치 점수들을 집적


### 이상치 비율
- 이상치 비율은 각 윈도우 마다 하나의 스칼라 값으로 이상치 점수가 계산되어진 이후에 전체 윈도우 중에서 검증 데이터 셋으로 얻은 임계값을 기준으로 임계값보다 이상치 점수가 큰 윈도우 개수를 계산
- 이상치 비율 계산식  


![캡처2](https://user-images.githubusercontent.com/62432967/128653974-1f0fd4a9-fb5c-480c-a28f-19581f8fdea3.PNG)  


- 이상치 점수가 계산되고 이상치 비율이 계산되는 과정  


![캡처3](https://user-images.githubusercontent.com/62432967/128653988-c0b03774-7f8b-4e4f-983b-19ffc98f0e30.PNG)



## **실험 결과 - 실제 노인 우울 탐지 데이터에 적용한 실험 결과**
본 논문에서 제안된 방법은 노인우울 탐지 문제에 적용되었으며 데이터는 노인 10여명을 대상으로 31일간 웨어러블 디바이스를 통해 수집된 생체신호데이터와 매일 오전 오후의 기분을 조사한 우울감 설문 결과를 가지고 실험을 진행
- 총 5개의 입력변수들을 갖고 모델 학습을 진행
- 로버스트 웨이블릿 필터링과 CAE를 함께한 모델을 RWCAE, 
- 일반 웨이브릿 필터링과 CAE를 함께 한 모델은 WCAE,
- 필터링 없이 CAE만 가지고 만든 모델은 CAE로 표기


- **모델들의 reconstruction error를 MSE로 비교한 결과**  


 ![그림2](https://user-images.githubusercontent.com/62432967/128638192-3a66f9a8-e9b2-47bb-b6e7-a2f19a5315b7.png)  
 
   -> MSE를 가지고 정상으로 훈련한 모델로 정상과 우울한날을 비교할 때에 둘의 차이가 극명하지 않아 우울한 날의 탐지가 어려움을 확인  



- **논문에서 제안한 이상치 스코어를 계산하여 평균을 구한 결과**  


 ![그림3](https://user-images.githubusercontent.com/62432967/128638204-00f408d3-419f-4734-9ba2-7ee65f36d6fb.png)  
 
   -> 데이터에서의 이상치 점수 척도를 가지고 정상과 우울한 날 데이터 점수를 보면 우울한 날을 탐지할 경우 더 구별이 뚜렷하게 됨  



- 특히 50에포크로 하여 학습한 경우, 필터링이 전혀 이루어지지 않아 노이즈의 영향을 많이 받는 CAE모델의 경우 정상인 날과 우울한 날에 대한 비교가 정상적으로 이루어지지 않음을 보임
- **로버스트한 값들을 활용하여 노이즈의 영향을 줄인 RWCAE와 WCAE 모델**의 경우 윈도우 스코어를 계산함으로써 전체 데이터에 대한 이상치 스코어링의 결과를 볼 때, **이상치인 우울한 날에 대한 점수가 정상인 날에 대한 점수보다 확연히 높았다**.

  
    
    
## **결론**
- **노이즈**에 대한 영향에 대해 **로버스트한 임계값**을 주고 필터링한 것만 아닌 **로버스트한 통계량을 사용하여 이상한 데이터에 대해 탐지**할 수 있는 방법
- 다변량 데이터에서의 **이상치 탐지의 어려움을 해결하고자 로버스트 통계량을 사용한 가중합을 함**으로써 보다 강건하고 설명력있는 점수를 계산
- 실제 노인 우울 탐지 데이터에 적용하였을 때 **로버스트 통계량으로 임계값을 정해 필터링하고 로버스트 통계량으로 이상치 점수를 계산한 모델**이 그렇지 않은 모델들보다 우울한 날과 우울하지 않은 날을 **더 잘 구별**할 수 있음

